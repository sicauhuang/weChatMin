<view class="car-form-page">
  <!-- 加载状态 -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 表单内容 -->
  <scroll-view
    class="form-container"
    scroll-y
    enhanced="true"
    scroll-top="{{scrollTop}}"
    scroll-with-animation="true">
    <!-- 车辆信息 -->
    <van-cell-group title="车辆信息" border="{{false}}">
      <!-- 车辆名称 -->
      <van-field
        value="{{formData.carName}}"
        placeholder="请输入"
        label="车辆名称"
        border="{{false}}"
        data-field="carName"
        bind:change="onInputChange" />

      <!-- 品牌车型 -->
      <van-cell
        title="品牌车型"
        value="{{formData.brandModel || '请选择车型'}}"
        is-link
        required
        class="car-brandModel"
        bind:click="showVehiclePicker"
        arrow-direction="down" />

      <!-- 车龄 -->
      <van-field
        value="{{formData.carAge}}"
        placeholder="请输入"
        label="车龄"
        type="number"
        required
        border="{{false}}"
        data-field="carAge"
        bind:change="onInputChange"
        use-button-slot
      >
        <view slot="button" class="field-unit">年</view>
      </van-field>

      <!-- 里程数 -->
      <van-field
        value="{{formData.mileage}}"
        placeholder="请输入"
        label="里程数"
        type="digit"
        required
        border="{{false}}"
        data-field="mileage"
        bind:change="onInputChange"
        use-button-slot
      >
        <view slot="button" class="field-unit">万公里</view>
      </van-field>

      <!-- 车辆颜色 -->
      <van-field
        value="{{formData.color}}"
        placeholder="请输入"
        label="车辆颜色"
        required
        border="{{false}}"
        data-field="color"
        bind:change="onInputChange" />

      <!-- 过户次数 -->
      <van-field
        value="{{formData.transferCount}}"
        placeholder="请输入"
        label="过户次数"
        type="number"
        border="{{false}}"
        data-field="transferCount"
        bind:change="onInputChange" />

      <!-- 上牌日期 -->
      <van-cell
        title="上牌日期"
        value="{{formData.plateDate || '请选择'}}"
        is-link
        class="car-plateDate"
        bind:click="showDatePicker"
        arrow-direction="down" />

      <!-- 上牌城市 -->
      <van-field
        value="{{formData.plateCity}}"
        placeholder="请输入"
        label="上牌城市"
        border="{{false}}"
        data-field="plateCity"
        bind:change="onInputChange" />

      <!-- 使用性质 -->
      <van-field
        value="{{formData.usageType}}"
        placeholder="请输入"
        label="使用性质"
        border="{{false}}"
        data-field="usageType"
        bind:change="onInputChange" />

      <!-- 车况描述 -->
      <van-field
        value="{{formData.condition}}"
        placeholder="请描述车辆状况，如保养记录、事故情况等..."
        label="车况描述"
        type="textarea"
        autosize
        maxlength="200"
        show-word-limit
        border="{{false}}"
        data-field="condition"
        bind:change="onInputChange" />

      <!-- 加装项目 -->
      <van-field
        value="{{formData.modifications}}"
        placeholder="请描述加装的项目，如导航、倒车雷达等..."
        label="加装项目"
        type="textarea"
        autosize
        maxlength="200"
        show-word-limit
        border="{{false}}"
        data-field="modifications"
        bind:change="onInputChange" />
    </van-cell-group>

    <!-- 售卖信息 -->
    <van-cell-group title="售卖信息" border="{{false}}">
      <!-- 底价（审批模式下隐藏） -->
      <van-field
        value="{{formData.lowPrice}}"
        placeholder="请输入"
        label="底价"
        type="digit"
        required
        border="{{false}}"
        data-field="lowPrice"
        bind:change="onInputChange"
        use-button-slot
      >
        <view slot="button" class="field-unit">万元</view>
      </van-field>

      <!-- 售价 -->
      <van-field
        value="{{formData.sellPrice}}"
        placeholder="请输入"
        label="售价"
        type="digit"
        required
        border="{{false}}"
        data-field="sellPrice"
        bind:change="onInputChange"
        use-button-slot
      >
        <view slot="button" class="field-unit">万元</view>
      </van-field>

      <!-- 联系方式 -->
      <van-field
        value="{{formData.contactInfo}}"
        placeholder="请输入"
        label="联系方式"
        type="number"
        required
        border="{{false}}"
        data-field="contactInfo"
        bind:change="onInputChange" />
    </van-cell-group>

    <!-- 车辆照片 -->
    <van-cell-group title="车辆照片（最多20张）" border="{{false}}">
      <van-cell>
      <van-uploader
        file-list="{{imageList}}"
        bind:after-read="onImageUpload"
        bind:delete="onImageDelete"
        max-count="20"
        multiple="{{true}}"
        preview-size="180rpx"
        upload-text="添加照片" />
      </van-cell>
    </van-cell-group>

    <!-- 审批意见（仅在审批模式下显示） -->
    <van-cell-group wx:if="{{mode === 'approval'}}" title="审批意见" border="{{false}}">
      <van-field
        value="{{formData.approveRemark}}"
        placeholder="请输入审批意见"
        label="审批意见"
        type="textarea"
        autosize
        maxlength="200"
        show-word-limit
        clearable
        required
        border="{{false}}"
        data-field="approveRemark"
        bind:change="onInputChange" />
    </van-cell-group>

    <!-- 占位空间 -->
    <view style="height:40rpx;"></view>
  </scroll-view>

  <!-- 底部提交按钮 -->
  <view class="form-actions">
    <!-- 审批模式显示“通过”和“驳回”按钮 -->
    <view wx:if="{{mode === 'approval'}}" class="approval-actions">
      <van-button
        type="danger"
        size="large"
        loading="{{submitting && approvalAction === 'REJECTED'}}"
        class="approval-button approval-reject-button"
        bind:click="onReject">
        驳回
      </van-button>
      <van-button
        type="primary"
        size="large"
        loading="{{submitting && approvalAction === 'APPROVED'}}"
        class="approval-button approval-approve-button"
        bind:click="onApprove">
        通过
      </van-button>
    </view>

    <!-- 新建/编辑模式显示保存按钮 -->
    <van-button
      wx:else
      type="primary"
      size="large"
      loading="{{submitting}}"
      class="submit-button"
      bind:click="onSave">
      {{mode === 'edit' ? '更新' : '发布'}}
    </van-button>
  </view>

  <!-- Vant 选择器弹窗 -->


  <!-- 日期选择器 -->
  <van-popup show="{{showDatePopup}}" position="bottom" bind:close="hideDatePicker">
    <van-datetime-picker
      type="date"
      value="{{currentDate}}"
      bind:confirm="onDateConfirm"
      bind:cancel="hideDatePicker" />
  </van-popup>

  <!-- 车型选择器 -->
  <vehicle-picker
    show="{{showVehiclePicker}}"
    title="选择车型"
    default-value="{{vehicleDefaultValue}}"
    bind:onConfirm="onVehicleConfirm"
    bind:onCancel="onVehicleCancel"
    bind:onClose="hideVehiclePicker" />

  <!-- Toast 组件 -->
  <van-toast id="van-toast" />

  <!-- 操作选择弹窗 -->
  <van-dialog
    show="{{showActionDialog}}"
    message="车辆信息已成功保存，您希望："
    show-cancel-button
    confirm-button-text="继续新建"
    cancel-button-text="返回列表"
    confirm-button-color="#1989fa"
    bind:confirm="onContinueCreate"
    bind:cancel="onGoBack"
    bind:close="hideActionDialog" />

  <!-- 上传进度弹窗 -->
  <van-popup
    show="{{uploadProgress.show}}"
    overlay="{{true}}"
    close-on-click-overlay="{{false}}"
    position="center"
    custom-class="upload-progress-popup">
    <view class="upload-progress-container">
      <view class="upload-icon">
        <van-loading type="spinner" size="48rpx" color="#1989fa" />
      </view>
      <view class="upload-message">{{uploadProgress.message}}</view>
      <view class="upload-progress">
        <van-progress
          percentage="{{uploadProgress.percentage}}"
          stroke-width="6"
          color="#1989fa"
          pivot-text="{{uploadProgress.percentage}}%"
          show-pivot="{{true}}" />
      </view>
      <view class="upload-tip">请勿关闭页面，正在上传中...</view>
    </view>
  </van-popup>
</view>
