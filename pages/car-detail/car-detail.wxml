<view class="car-detail-page">

  <!-- 页面内容 -->
  <scroll-view class="detail-container" scroll-y="true" enhanced="true" wx:if="{{carDetail}}">
    <!-- 车辆图片轮播 -->
    <view class="detail-images">
      <swiper
        class="images-swiper"
        indicator-dots="true"
        indicator-color="rgba(255,255,255,0.5)"
        indicator-active-color="#FF8C00"
        autoplay="false"
        circular="true"
        bindchange="onImageSwiperChange"
        bindtap="onImagePreview">
        <swiper-item wx:for="{{carDetail.basicInfo.imageUrlList}}" wx:key="index">
          <image
            class="swiper-image"
            src="{{item.fileUrl}}"
            mode="scaleToFill" />
        </swiper-item>
      </swiper>

      <!-- 图片计数 -->
      <view class="image-counter" wx:if="{{carDetail.basicInfo.imageUrlList.length > 1}}">
        <text class="image-counter__text">{{currentImageIndex + 1}}/{{carDetail.basicInfo.imageUrlList.length}}</text>
      </view>
    </view>

    <!-- 车辆标题和价格 -->
    <view class="detail-header">
      <view class="detail-header__main">
        <text class="detail-header__title">{{carDetail.name}}</text>
      </view>
      <view class="detail-header__price">
        <text class="detail-header__price-text">{{carDetail.basicInfo.sellPrice}}</text>
        <text class="detail-header__price-unit">万元</text>
      </view>
    </view>

    <!-- Tab栏 -->
    <view class="detail-tabs">
      <view
        class="detail-tabs__item {{activeTab === 'basic' ? 'active' : ''}}"
        data-tab="basic"
        bindtap="onTabChange">
        <text class="detail-tabs__text">基本信息</text>
      </view>
      <view
        class="detail-tabs__item {{activeTab === 'config' ? 'active' : ''}}"
        data-tab="config"
        bindtap="onTabChange">
        <text class="detail-tabs__text">车辆配置</text>
      </view>
    </view>

    <!-- 基本信息 -->
    <view class="detail-card" wx:if="{{activeTab === 'basic'}}">
      <view class="detail-table">
        <view class="detail-table__row" wx:if="{{carDetail.basicInfo.age}}">
          <text class="detail-table__label">车龄</text>
          <text class="detail-table__value">{{carDetail.basicInfo.age}}年</text>
        </view>
        <view class="detail-table__row" wx:if="{{carDetail.basicInfo.color}}">
          <text class="detail-table__label">颜色</text>
          <text class="detail-table__value">{{carDetail.basicInfo.color}}</text>
        </view>
        <view class="detail-table__row" wx:if="{{carDetail.basicInfo.mileage}}">
          <text class="detail-table__label">里程</text>
          <text class="detail-table__value">{{carDetail.basicInfo.mileage}}万公里</text>
        </view>
        <view class="detail-table__row" wx:if="{{carDetail.basicInfo.transferCount !== null}}">
          <text class="detail-table__label">过户次数</text>
          <text class="detail-table__value">{{carDetail.basicInfo.transferCount}}次</text>
        </view>
        <view class="detail-table__row" wx:if="{{carDetail.basicInfo.licenseDate}}">
          <text class="detail-table__label">上牌日期</text>
          <text class="detail-table__value">{{carDetail.basicInfo.licenseDate}}</text>
        </view>
        <view class="detail-table__row" wx:if="{{carDetail.basicInfo.licenseCity}}">
          <text class="detail-table__label">上牌城市</text>
          <text class="detail-table__value">{{carDetail.basicInfo.licenseCity}}</text>
        </view>
        <view class="detail-table__row" wx:if="{{carDetail.basicInfo.usage}}">
          <text class="detail-table__label">使用性质</text>
          <text class="detail-table__value">{{carDetail.basicInfo.usage}}</text>
        </view>
        <view class="detail-table__row" wx:if="{{carDetail.basicInfo.remark}}">
          <text class="detail-table__label">车况描述</text>
          <text class="detail-table__value">{{carDetail.basicInfo.remark}}</text>
        </view>
        <view class="detail-table__row" wx:if="{{carDetail.basicInfo.modifyItems}}">
          <text class="detail-table__label">加装项目</text>
          <text class="detail-table__value">{{carDetail.basicInfo.modifyItems}}</text>
        </view>
      </view>
    </view>

    <!-- 车辆配置 -->
    <view class="detail-card" wx:if="{{activeTab === 'config' && carDetail.modelInfo}}">
      <view class="detail-table">
        <view class="detail-table__row" wx:if="{{carDetail.modelInfo.energyType}}">
          <text class="detail-table__label">能源类型</text>
          <text class="detail-table__value">{{carDetail.modelInfo.energyType}}</text>
        </view>
        <view class="detail-table__row" wx:if="{{carDetail.modelInfo.displacement}}">
          <text class="detail-table__label">排量</text>
          <text class="detail-table__value">{{carDetail.modelInfo.displacement}}</text>
        </view>
        <view class="detail-table__row" wx:if="{{carDetail.modelInfo.transmissionType}}">
          <text class="detail-table__label">变速箱类型</text>
          <text class="detail-table__value">{{carDetail.modelInfo.transmissionType}}</text>
        </view>
        <view class="detail-table__row" wx:if="{{carDetail.modelInfo.driveType}}">
          <text class="detail-table__label">驱动方式</text>
          <text class="detail-table__value">{{carDetail.modelInfo.driveType}}</text>
        </view>
        <view class="detail-table__row" wx:if="{{carDetail.modelInfo.bodyStructure}}">
          <text class="detail-table__label">车身结构</text>
          <text class="detail-table__value">{{carDetail.modelInfo.bodyStructure}}</text>
        </view>
        <view class="detail-table__row" wx:if="{{carDetail.modelInfo.seatCount}}">
          <text class="detail-table__label">座位数</text>
          <text class="detail-table__value">{{carDetail.modelInfo.seatCount}}座</text>
        </view>
        <view class="detail-table__row" wx:if="{{carDetail.modelInfo.guidePrice}}">
          <text class="detail-table__label">新车指导价</text>
          <text class="detail-table__value">{{carDetail.modelInfo.guidePrice}}万元</text>
        </view>
        <view class="detail-table__row" wx:if="{{carDetail.modelInfo.batteryCapacity}}">
          <text class="detail-table__label">电池容量</text>
          <text class="detail-table__value">{{carDetail.modelInfo.batteryCapacity}}kWh</text>
        </view>
        <view class="detail-table__row" wx:if="{{carDetail.modelInfo.batteryType}}">
          <text class="detail-table__label">电池类型</text>
          <text class="detail-table__value">{{carDetail.modelInfo.batteryType}}</text>
        </view>
        <view class="detail-table__row" wx:if="{{carDetail.modelInfo.comprehensiveRange}}">
          <text class="detail-table__label">综合续航</text>
          <text class="detail-table__value">{{carDetail.modelInfo.comprehensiveRange}}公里</text>
        </view>
        <view class="detail-table__row" wx:if="{{carDetail.modelInfo.pureElectricRange}}">
          <text class="detail-table__label">纯电续航</text>
          <text class="detail-table__value">{{carDetail.modelInfo.pureElectricRange}}公里</text>
        </view>
        <view class="detail-table__row" wx:if="{{carDetail.modelInfo.motorPower}}">
          <text class="detail-table__label">电动机马力</text>
          <text class="detail-table__value">{{carDetail.modelInfo.motorPower}}PS</text>
        </view>
        <view class="detail-table__row" wx:if="{{carDetail.modelInfo.motorCount}}">
          <text class="detail-table__label">驱动电机数</text>
          <text class="detail-table__value">{{carDetail.modelInfo.motorCount}}个</text>
        </view>
      </view>
    </view>

    <!-- 车辆实拍 -->
    <view class="detail-card">
      <view class="detail-card__header">
        <text class="detail-card__title">车辆实拍</text>
      </view>
      <view class="detail-photos">
        <view
          class="detail-photos__item"
          wx:for="{{carDetail.basicInfo.imageUrlList}}"
          wx:key="index"
          data-index="{{index}}"
          bindtap="onPhotoTap">
          <image
            class="detail-photos__image"
            src="{{item.fileUrl}}"
            mode="aspectFill" />
        </view>
      </view>
    </view>

    <!-- 占位空间 -->
    <view class="detail-spacer"></view>
  </scroll-view>

  <!-- 底部操作按钮 -->
  <view class="detail-actions" wx:if="{{carDetail}}">
    <button
      class="detail-actions__button detail-actions__button--favorite {{carDetail.basicInfo.favorStatus === 'FAVORITE' ? 'favorited' : ''}}"
      bindtap="onToggleFavorite">
      <text class="iconfont {{carDetail.basicInfo.favorStatus === 'FAVORITE' ? 'icon-yishoucang' : 'icon-shoucang'}} detail-actions__button-icon"></text>
      {{carDetail.basicInfo.favorStatus === 'FAVORITE' ? '已收藏' : '收藏'}}
    </button>
    <permission-wrapper permission="miniprogram:action.view-floor-price">
      <button
        class="detail-actions__button detail-actions__button--price"
        bindtap="onShowFloorPrice">
        <text class="iconfont icon-jiage detail-actions__button-icon"></text>
        查看底价
      </button>
    </permission-wrapper>
    <button
      class="detail-actions__button detail-actions__button--contact"
      bindtap="onCallPhone">
      <text class="iconfont icon-dianhua detail-actions__button-icon"></text>
      联系卖家
    </button>
  </view>

  <!-- 底价弹窗 -->
  <view class="floor-price-modal" wx:if="{{showFloorPriceModal}}" bindtap="onHideFloorPriceModal">
    <view class="floor-price-modal__content" catchtap="">
      <view class="floor-price-modal__header">
        <text class="floor-price-modal__title">车辆底价</text>
        <text class="iconfont icon-guanbi floor-price-modal__close" bindtap="onHideFloorPriceModal"></text>
      </view>
      <view class="floor-price-modal__body">
        <view class="floor-price-info">
          <text class="floor-price-info__label">底价</text>
          <text class="floor-price-info__value">{{carDetail.basicInfo.floorPrice}}万元</text>
        </view>
        <text class="floor-price-info__note">此价格为车主设定的最低价格，仅供参考</text>
      </view>
    </view>
  </view>
</view>
