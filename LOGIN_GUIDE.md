# 微信小程序登录功能使用指南

## 项目预研内容2 - 登录页逻辑实现

本文档说明如何使用已实现的微信小程序登录功能。

## 功能概述

实现了完整的微信小程序登录流程，包括：
- 调用微信登录接口获取临时登录凭证 code
- 后端服务处理 code 并获取 openid 和 session_key
- 获取用户信息（昵称、头像）
- 本地存储用户信息
- 登录状态管理

## 架构说明

### 前端（小程序）
- **页面**: `pages/login/login`
- **主要功能**:
  - 显示登录状态（已登录/未登录）
  - 处理登录点击事件
  - 调用微信登录API
  - 与后端服务通信
  - 本地存储管理

### 后端服务
- **技术栈**: Node.js + Express
- **端口**: 3000
- **主要接口**:
  - `POST /api/login` - 处理登录请求
  - `GET /api/health` - 健康检查

## 使用步骤

### 1. 启动后端服务

```bash
cd server
npm start
```

服务启动后会显示：
```
服务器已启动，端口: 3000
健康检查: http://localhost:3000/api/health
登录接口: http://localhost:3000/api/login
```

### 2. 配置微信开发者工具

1. 打开微信开发者工具
2. 导入项目（选择项目根目录）
3. 在开发者工具中：
   - 点击右上角"详情"
   - 在"本地设置"中勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"
   - 这样可以访问本地的 http://localhost:3000 服务

### 3. 测试登录功能

1. 在微信开发者工具中运行小程序
2. 切换到"我的"页面（login页面）
3. 点击头像或"未登录"文字
4. 按照提示完成登录流程

## 登录流程详解

### 完整登录流程

1. **用户点击登录区域**
   - 触发 `handleLogin()` 方法

2. **调用微信登录接口**
   - 执行 `wx.login()` 获取临时登录凭证 code

3. **后端处理登录**
   - 前端将 code 发送到 `http://localhost:3000/api/login`
   - 后端使用 code + appId + appSecret 调用微信接口
   - 微信返回 openid 和 session_key
   - 后端将结果返回给前端

4. **获取用户信息**
   - 前端调用 `wx.getUserProfile()` 获取用户昵称和头像

5. **存储和显示**
   - 合并用户信息和 openid
   - 存储到本地缓存 `wx.setStorageSync('userInfo', userInfo)`
   - 更新页面显示状态

### 已登录状态功能

- 点击用户信息区域会显示用户详情弹窗
- 可以查看用户昵称和 OpenID
- 提供退出登录功能

## 配置信息

### 微信小程序配置
- **AppID**: wxd07a1bb6cb343ba9
- **AppSecret**: 8032855026a9317457890ed52638dae6

### 后端服务配置
- **端口**: 3000
- **CORS**: 已启用，支持跨域请求
- **请求格式**: JSON

## 错误处理

系统包含完善的错误处理机制：

1. **网络错误**: 显示网络请求失败提示
2. **微信接口错误**: 显示具体的微信接口错误信息
3. **用户拒绝授权**: 显示获取用户信息失败提示
4. **服务器错误**: 显示服务器内部错误信息

## 本地存储结构

用户信息存储在 `wx.getStorageSync('userInfo')` 中，包含：

```javascript
{
  nickName: "用户昵称",
  avatarUrl: "用户头像URL",
  openid: "微信用户唯一标识",
  session_key: "会话密钥",
  loginTime: "登录时间（ISO格式）"
}
```

## 开发注意事项

1. **本地开发**: 需要在微信开发者工具中关闭域名校验
2. **生产环境**: 需要将后端服务部署到HTTPS域名，并在小程序后台配置合法域名
3. **安全性**: AppSecret 不应该暴露在前端代码中，实际项目中应该妥善保管
4. **用户体验**: 登录过程中会显示加载提示，避免用户重复操作

## 测试验证

可以通过以下方式验证功能：

1. **后端服务测试**:
   ```bash
   curl http://localhost:3000/api/health
   ```

2. **登录流程测试**:
   - 在小程序中完成一次完整的登录流程
   - 检查控制台日志输出
   - 验证本地存储中的用户信息

3. **状态持久化测试**:
   - 登录后关闭小程序
   - 重新打开小程序，验证登录状态是否保持

## 项目文件结构

```
├── server/                 # 后端服务
│   ├── app.js             # Express服务器主文件
│   ├── package.json       # 依赖配置
│   └── node_modules/      # 依赖包
├── pages/login/           # 登录页面
│   ├── login.js          # 页面逻辑（包含完整登录流程）
│   ├── login.wxml        # 页面结构
│   ├── login.wxss        # 页面样式
│   └── login.json        # 页面配置
├── project.config.json    # 项目配置（已关闭域名校验）
└── LOGIN_GUIDE.md        # 本使用指南
```

## 总结

项目预研内容2已完成，实现了完整的微信小程序登录功能，包括前端登录逻辑和后端服务。用户可以通过点击登录区域完成微信授权登录，获取用户信息并持久化存储。
