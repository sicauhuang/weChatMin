### 文件上传系统

#### 需求目的

本文档主要记录当前系统如何实现文件上传功能。

#### 文件上传流程

1、文件上传时，需要获取文件上传到腾讯云COS的预签名URL
2、将获取到的预签名URL作为文件上传地址，将文件数据使用put，二进制数据直接进行数据上传

#### 文件上传架构设计

根据上传流程，目前系统上传是一个多图片文件上传的场景，需要设计一个文件上传的流式上传管理器。
管理器职责：

- 根据需要上传的文件数量，获取腾讯云COS的预签名URL
- 设置最大上传数量为4，避免一次性上传过多文件
- 上传失败需要支持重试机制
- 上传回调，告知调用方上传结果
- 上传需要与antd的upload组件结合使用

#### 逻辑设计

- 前端：小程序端在新增车辆的表单页面中，需要进行文件上传，需要先收集图片数据，不能直接进行上传。
- 在用户点击保存后，前端将上传组件中获取文件数据转交到本次设计的文件上传系统。

- 文件系统功能：
1、文件系统创建上传功能接受三个参数：
- fileList：用户上传的文件列表
- type: 上传的文件类型，分为car，logo
- callback：上传完成后的回调函数，包括成功与失败的文件列表

2、文件系统创建上传功能：根据传入的需要上传的文件数据fileList，为fileList的每一个file文件创建一个UUID生成的随机名称，需要根据type与uuid生成这次需要上传的文件名称：格式为：type/uuid.png。如：car/1234567890.png。后缀名称统一为png

3、根据预签名URL获取接口获取每个文件名称对应的上传接口路径。

4、将生成的随机UUID名称使用对应的上传的预签名接口上传到腾讯云COS。需要设置最大上传数据为4个，当其中有文件上传失败时，允许重试3次，3次都失败后，则设置该上传任务失败，记录失败文件列表。如果文件上传成功，则记录成功文件列表，检查是否还有未上传的任务，如果有，则继续上传，直到所有文件上传完成。

5、上传任务全部完成后，调用回调函数，告知上传结果，返回当前成功的图片名称列表。名称格式是内部定义的名称格式，如：“car/1234567890.png”

#### 接口设计

 查询上传文件URL（小程序接口）

**接口描述**：获取文件上传到腾讯云COS的预签名URL，用于小程序端文件上传

**请求方式**：POST

**请求路径**：`/api/mp/file/query-upload-url`

**请求参数**：

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| fileNameList | Array | 是 | 文件名数组，支持品牌logo和车辆图片格式 |

**fileNameList数组元素格式说明**：

- 品牌logo格式：`logo/uuid.ext`，例如：`logo/1234567890.png`
- 车辆图片格式：`car/uuid.ext`，例如：`car/1234567890.png`

**请求示例**：

```json
{
  "fileNameList": [
    "logo/1234567890.png",
    "car/9876543210.jpg"
  ]
}
```

**响应参数**：

| 参数名 | 类型 | 描述 |
|--------|------|------|
| code | Integer | 响应状态码，200表示成功 |
| message | String | 响应消息 |
| data | Array | 上传URL信息数组 |
| data[].fileName | String | 文件名，上传到COS后的文件名 |
| data[].uploadUrl | String | 直接上传文件到COS的URL，使用PUT方法 |

#### 文件上传功能接入

需求文档:/Users/xiaofeng/WeChatProjects/miniprogram-1/prompt/prompt.md
在车辆表单上传页面：/Users/xiaofeng/WeChatProjects/miniprogram-1/pages/car-form

在车辆表单上传页面，图片上传后数据是使用页面变量暂时存储的，在点击保存时需要先进行文件上传流程，上传完成再将成功的文件名称列表与表单数据进行后端数据提交。

保存按钮逻辑：
1、收集表单数据
2、将图片文件数据通过上传工具进行文件上传，
3、在prompt.md记录了新增车辆与编辑车辆接口，在请求参数不变的情况下，新增参数：

- imageFileIds：sting, 上传完成的文件名称（car/uuid.png）的字符串，多个名称使用逗号分割。
