# 微信小程序真机调试指南

## 概述

本指南说明如何使用已配置的真机调试功能，支持在真实手机设备上测试微信小程序登录功能。

## 当前配置状态

### 服务器配置
- ✅ 服务器已配置为监听所有网络接口（0.0.0.0）
- ✅ 自动获取并显示局域网IP地址
- ✅ 当前局域网IP：`192.168.124.8`
- ✅ 真机调试API地址：`http://192.168.124.8:3000`

### 前端配置
- ✅ 已创建API配置管理系统（`config/api.js`）
- ✅ 支持本地开发和真机调试模式切换
- ✅ 默认使用本地开发模式（localhost）

## 真机调试步骤

### 1. 启动后端服务

```bash
cd server
npm start
```

服务启动后会显示：
```
服务器已启动，端口: 3000
本地访问: http://localhost:3000
局域网访问: http://192.168.124.8:3000

=== 真机调试地址 ===
健康检查: http://192.168.124.8:3000/api/health
登录接口: http://192.168.124.8:3000/api/login
```

### 2. 切换到真机调试模式

有两种方式切换到真机调试模式：

#### 方式一：修改配置文件（推荐）
编辑 `config/api.js` 文件：
```javascript
const currentEnv = {
  mode: 'localNetwork', // 改为 'localNetwork'
  // ...
};
```

#### 方式二：在小程序中动态切换
在小程序的任何页面中调用：
```javascript
const apiConfig = require('../../config/api.js');
apiConfig.switchToLocalNetwork(); // 切换到真机调试模式
```

### 3. 微信开发者工具配置

1. **打开项目设置**
   - 点击微信开发者工具右上角的"详情"按钮

2. **配置本地设置**
   - 在"本地设置"选项卡中
   - ✅ 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"
   - ✅ 勾选"不校验 HTTPS 证书"

3. **启用真机调试**
   - 点击工具栏的"真机调试"按钮
   - 使用微信扫描二维码
   - 确保手机和电脑在同一WiFi网络

### 4. 网络环境检查

#### 必要条件：
- ✅ 手机和电脑连接同一WiFi网络
- ✅ 电脑防火墙允许3000端口访问
- ✅ 路由器没有禁用设备间通信

#### 网络测试：
在手机浏览器中访问：`http://192.168.124.8:3000/api/health`
如果返回JSON数据，说明网络连接正常。

### 5. 测试登录功能

1. 在真机调试模式下打开小程序
2. 切换到"我的"页面（login页面）
3. 点击头像或"未登录"区域
4. 按照提示完成登录流程
5. 查看开发者工具控制台的日志输出

## 调试模式切换

### 本地开发模式（默认）
```javascript
// config/api.js
mode: 'localhost' // 使用 http://localhost:3000
```
- 适用于：微信开发者工具模拟器调试
- API地址：`http://localhost:3000/api/login`

### 真机调试模式
```javascript
// config/api.js
mode: 'localNetwork' // 使用 http://192.168.124.8:3000
```
- 适用于：真实手机设备调试
- API地址：`http://192.168.124.8:3000/api/login`

### 生产模式（预留）
```javascript
// config/api.js
mode: 'server' // 使用正式服务器地址
```
- 适用于：正式发布版本
- 需要配置正式的HTTPS服务器地址

## 常见问题解决

### 1. 网络连接失败
**问题**：手机无法访问电脑的API服务
**解决方案**：
- 确认手机和电脑在同一WiFi网络
- 检查电脑防火墙设置，允许3000端口
- 尝试在手机浏览器访问健康检查接口

### 2. IP地址变化
**问题**：电脑重启后局域网IP发生变化
**解决方案**：
- 重新启动服务器，查看新的IP地址
- 更新 `config/api.js` 中的 `localNetwork` 地址
- 或使用动态切换方法：`apiConfig.switchToLocalNetwork('新IP')`

### 3. 微信登录失败
**问题**：真机调试时微信登录接口调用失败
**解决方案**：
- 确认已在微信开发者工具中关闭域名校验
- 检查AppID和AppSecret配置是否正确
- 查看服务器控制台的错误日志

### 4. 用户信息获取失败
**问题**：wx.getUserProfile调用失败
**解决方案**：
- 确保在真机环境下测试（模拟器可能不支持）
- 检查微信版本是否支持getUserProfile接口
- 确认用户已授权获取用户信息

## 调试日志

### 服务器日志
服务器会输出详细的请求日志：
```
正在调用微信登录接口...
微信登录成功, openid: xxxxxx
```

### 前端日志
小程序控制台会显示：
```
使用API地址: http://192.168.124.8:3000/api/login
wx.login成功，code: xxxxxx
获取openid成功: xxxxxx
获取用户信息成功: {...}
```

## 性能优化建议

1. **网络优化**：确保WiFi信号稳定
2. **缓存策略**：登录成功后信息会缓存到本地
3. **错误重试**：网络失败时可以重试登录
4. **日志监控**：关注控制台日志，及时发现问题

## 下一步计划

1. **HTTPS支持**：为生产环境配置HTTPS服务
2. **云服务部署**：将服务部署到云服务器
3. **域名配置**：在微信小程序后台配置合法域名
4. **安全加固**：加强API安全性和数据加密

## 总结

当前真机调试方案已完全配置完成，支持：
- ✅ 自动获取局域网IP
- ✅ 灵活的环境切换
- ✅ 完整的登录流程
- ✅ 详细的调试日志
- ✅ 错误处理机制

可以开始进行真机调试测试了！
